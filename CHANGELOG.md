# 作業記録

## 2024年 - ポケモンフレンダサポートカード作成ツール実装

### プロジェクト概要

ポケモンフレンダのサポートカード画像をシールサイズにリサイズして、コンビニのシール印刷サービスで印刷できる形式に変換するWebアプリケーションを開発しました。

### 背景

5歳の男の子がポケモンフレンダというゲームセンターのゲームを楽しんでおり、フレンダピックというプラスチック製のポケモンおもちゃを集めています。ゲームにはサポートカードという紙製のカードが必要で、このカードを画像データからシールに印刷してフレンダピックに貼り付けることで、プラスチック製のサポートカードを作成できるようにすることを目的としています。

### 実装した機能

#### 1. 画像アップロード機能
- **ドラッグ&ドロップ対応**: 画像ファイルをドラッグ&ドロップでアップロード可能
- **クリック選択**: クリックしてファイル選択ダイアログから画像を選択可能
- **対応形式**: PNG、JPG、JPEG形式に対応
- **リアルタイムプレビュー**: アップロードした画像をすぐにプレビュー表示

#### 2. 画像リサイズ機能
- **シールサイズオプション**:
  - 50mm × 50mm（標準サイズ・推奨）
  - 40mm × 40mm
  - 60mm × 60mm
  - 50mm × 30mm（横長）
  - カスタムサイズ（幅・高さを自由に設定可能）
- **DPI設定**:
  - 300 DPI（高品質・推奨）
  - 150 DPI（標準）
  - 96 DPI（低品質）
- **アスペクト比保持**: 元の画像のアスペクト比を保持しながらリサイズ
- **リアルタイムプレビュー**: リサイズ後の画像を即座にプレビュー表示
- **サイズ情報表示**: リサイズ後のサイズ（mm、px、DPI）を表示

#### 3. 画像ダウンロード機能
- **PNG形式で保存**: リサイズ後の画像をPNG形式でダウンロード
- **ファイル名自動生成**: サイズとDPIを含む分かりやすいファイル名を自動生成
  - 例: `support-card-50x50-300dpi.png`

#### 4. QRコード検出バリデーション機能
- **自動QRコード検出**: 画像アップロード時にQRコードの有無を自動チェック
- **jsQRライブラリ**: 軽量で高精度なQRコード検出ライブラリを使用
- **エラーメッセージ表示**: QRコードが検出されない場合、分かりやすいエラーメッセージを表示
- **エラーハンドリング**: エラーメッセージは5秒後に自動で閉じる、または手動で閉じることが可能
- **処理最適化**: 大きな画像は処理前にリサイズ（最大1000px）して検出精度を向上

#### 5. UI/UX改善
- **使い方ガイド**: 3ステップの使い方を視覚的に説明
- **レスポンシブデザイン**: モバイル、タブレット、デスクトップに対応
- **モダンなデザイン**: ポケモンテーマに合わせたカラースキーム
- **直感的な操作**: わかりやすいUIで誰でも簡単に使用可能
- **エラーメッセージUI**: 視覚的に分かりやすいエラーメッセージ表示（スライドダウンアニメーション）

### 技術スタック

- **HTML5**: セマンティックなマークアップ
- **CSS3**:
  - CSS Grid / Flexbox レイアウト
  - CSS変数（カスタムプロパティ）
  - レスポンシブデザイン
  - アニメーション
- **JavaScript (Vanilla)**:
  - File API（画像アップロード）
  - Canvas API（画像リサイズ）
  - Drag & Drop API
  - Intersection Observer API（スクロールアニメーション）
- **外部ライブラリ**:
  - jsQR (v1.4.0): QRコード検出ライブラリ（CDN経由）

### ファイル構成

```
website-project/
├── index.html          # メインHTMLファイル
├── styles.css          # スタイルシート
├── script.js           # JavaScript機能
├── 要件.md             # プロジェクト要件
├── CHANGELOG.md        # このファイル（作業記録）
├── README.md           # プロジェクト説明
└── vercel.json         # Vercelデプロイ設定
```

### 実装の詳細

#### 画像リサイズアルゴリズム

1. **mmからピクセルへの変換**:
   ```javascript
   function mmToPixels(mm, dpi) {
       return Math.round((mm / 25.4) * dpi);
   }
   ```

2. **アスペクト比の保持**:
   - 元の画像のアスペクト比を計算
   - キャンバスのアスペクト比と比較
   - 画像が横長の場合は高さに合わせ、縦長の場合は幅に合わせてリサイズ
   - 余白は白背景で埋める

3. **Canvas APIを使用した描画**:
   - Canvas要素にリサイズ後の画像を描画
   - 高品質な画像出力を実現

#### 主要な機能実装

- **ファイルアップロード**: `FileReader` APIを使用して画像を読み込み
- **画像プレビュー**: `Image` オブジェクトとCanvasを使用
- **ダウンロード**: `toBlob()` メソッドでPNG形式に変換してダウンロード

#### QRコード検出アルゴリズム

1. **画像の前処理**:
   - アップロードされた画像を一時的なCanvasに描画
   - 大きな画像（1000px超）は処理前にリサイズして検出精度を向上
   - ImageDataを取得してjsQRライブラリに渡す

2. **QRコード検出**:
   ```javascript
   const code = jsQR(imageData.data, imageData.width, imageData.height);
   ```

3. **バリデーション**:
   - QRコードが検出されない場合、エラーメッセージを表示
   - 処理を中断し、ユーザーに正しい画像のアップロードを促す
   - エラーメッセージは自動で閉じる（5秒後）または手動で閉じることが可能

### コミット履歴

- **コミット**: `e068954` - ポケモンフレンダサポートカード作成ツールを実装
  - 画像アップロード機能（ドラッグ&ドロップ対応）
  - シールサイズに合わせた画像リサイズ機能
  - 複数のシールサイズオプション（標準、カスタムサイズ対応）
  - DPI設定機能（300/150/96 DPI）
  - リサイズ画像のダウンロード機能
  - 使い方ガイドセクションを追加
  - 要件.mdを追加

- **コミット**: `f372e62` - QRコード検出バリデーション機能を追加
  - jsQRライブラリを使用したQRコード検出機能を実装
  - 画像アップロード時にQRコードの有無を自動チェック
  - QRコードが検出されない場合のエラーメッセージ表示機能
  - エラーメッセージのUI/UX改善（自動閉じる、手動閉じるボタン）
  - CHANGELOG.mdに作業記録を追加

- **コミット**: (最新) - Cursorルールファイルの追加とGitフックの削除
  - `.cursor/rules/`ディレクトリを作成し、Cursorエージェント用のルールファイルを追加
  - `commit_rules.mdc`: コミット前にCHANGELOG.mdの更新を確認するルール
  - `project_context.mdc`: プロジェクトの背景とコンテキスト情報
  - Gitフック（`.git/hooks/pre-commit`、`setup-git-hooks.sh`）を削除
  - README.mdを更新（Gitフックの記述を削除し、`.cursor/rules/`の方法に更新）

### 今後の改善案

1. **機能追加**:
   - 複数画像の一括処理
   - 画像の回転・反転機能
   - トリミング機能
   - 画像の明るさ・コントラスト調整
   - QRコードの内容を表示・検証する機能

2. **パフォーマンス改善**:
   - 大きな画像ファイルの処理最適化
   - Web Workersを使用した非同期処理

3. **ユーザビリティ向上**:
   - プリセットサイズの追加（一般的なシールサイズ）
   - 画像の品質設定
   - 処理中のローディング表示

4. **デザイン改善**:
   - ポケモンテーマに合わせたより詳細なデザイン
   - アニメーションの追加

### 使用上の注意

- ブラウザのCanvas APIの制限により、非常に大きな画像（10MB以上）の処理には時間がかかる場合があります
- モバイルブラウザでは、メモリ制限により大きな画像の処理ができない場合があります
- ダウンロードした画像は、コンビニのシール印刷サービスで使用する前に、実際のサイズを確認することを推奨します
- QRコード検出は画像の品質に依存します。ぼやけた画像や低解像度の画像では検出できない場合があります
- QRコードが画像の端に配置されている場合や、歪んでいる場合は検出が困難な場合があります

### 参考情報

- 一般的なコンビニシールサイズ: 50mm × 50mm
- 推奨DPI: 300 DPI（高品質印刷用）
- 対応ブラウザ: モダンブラウザ（Chrome, Firefox, Safari, Edge）

---

**作成日**: 2024年
**最終更新**: 2024年（QRコード検出バリデーション機能追加）

